# Система комиссий платформы

## Описание

Платформа использует комиссионную модель оплаты, где комиссия взимается с мебельщиков (мастеров), а не с клиентов. Клиенты платят напрямую мастерам за выполненную работу.

## Условия комиссии

### Первый месяц работы мастера
- **Фиксированная ставка**: 5,000₸ за каждый принятый заказ
- **Максимальное количество заказов**: 3 заказа
- **Максимальная сумма комиссии**: 15,000₸ (3 заказа × 5,000₸)

### После первого месяца
- **Процентная ставка**: 3% от суммы каждого заказа
- **Без ограничений** по количеству заказов

## Как это работает

### 1. Мастер регистрируется на платформе
- Дата регистрации записывается в профиль мастера
- Начинается отсчет первого месяца

### 2. Клиент создает заказ
- Клиент описывает свой заказ и указывает бюджет
- Заказ публикуется в аукционе для мастеров

### 3. Мастер делает предложение (ставку)
- Мастер видит предварительный расчет комиссии
- Система автоматически показывает:
  - Сумму комиссии
  - Тип комиссии (фиксированная или процентная)
  - Сумму, которую получит мастер после вычета комиссии

### 4. Клиент принимает предложение
- При принятии предложения создается транзакция комиссии
- Комиссия добавляется к балансу мастера
- Если это заказ первого месяца, увеличивается счетчик

### 5. Оплата комиссии
- Мастер видит баланс комиссий в разделе "Финансы > Комиссии"
- Может просмотреть историю всех транзакций
- Оплачивает комиссию платформе отдельно

### 6. Оплата за работу
- Клиент платит мастеру напрямую
- Платформа не участвует в этом процессе
- Способ оплаты согласовывается между клиентом и мастером

## Структура базы данных

### Таблица `master_profiles`
```sql
registered_at TIMESTAMP        -- Дата регистрации мастера
first_month_orders INTEGER     -- Количество заказов в первый месяц
commission_balance DECIMAL     -- Текущий баланс комиссий
total_commission_paid DECIMAL  -- Всего оплачено комиссий
```

### Таблица `commission_transactions`
```sql
id SERIAL PRIMARY KEY
master_id INTEGER              -- ID мастера
order_id INTEGER               -- ID заказа
order_amount DECIMAL           -- Сумма заказа
commission_amount DECIMAL      -- Сумма комиссии
commission_type VARCHAR        -- 'first_month' или 'percentage'
commission_rate DECIMAL        -- Процент (если применимо)
status VARCHAR                 -- 'pending', 'paid', 'cancelled'
created_at TIMESTAMP
paid_at TIMESTAMP
```

## API Endpoints

### Для мастеров

#### `GET /api/commissions/balance`
Получить баланс комиссий
```json
{
  "balance": 15000,
  "totalPaid": 50000,
  "pendingTransactions": 3
}
```

#### `GET /api/commissions/transactions`
Получить историю транзакций
```json
{
  "transactions": [
    {
      "id": 1,
      "order_title": "Кухонный гарнитур",
      "order_amount": 500000,
      "commission_amount": 5000,
      "commission_type": "first_month",
      "status": "pending",
      "created_at": "2025-11-10T12:00:00Z"
    }
  ]
}
```

#### `POST /api/commissions/calculate`
Рассчитать комиссию (предварительный расчет)
```json
{
  "orderAmount": 100000
}
```

Ответ:
```json
{
  "amount": 5000,
  "type": "first_month"
}
```
или
```json
{
  "amount": 3000,
  "type": "percentage",
  "rate": 3
}
```

### Для администраторов

#### `POST /api/commissions/transactions/:transactionId/pay`
Отметить комиссию как оплаченную

## Интерфейс для мастеров

### Страница "Комиссии" (`/master/commissions`)

**Отображает:**
- Информационный блок с условиями комиссии
- Текущий баланс к оплате
- Всего оплачено комиссий
- Количество неоплаченных транзакций
- Фильтры: Все / Ожидает оплаты / Оплачено
- Детальная история всех транзакций

**Для каждой транзакции показывается:**
- Название заказа
- Тип комиссии (первый месяц или процент)
- Сумма заказа
- Сумма комиссии
- Статус оплаты
- Дата создания

### Форма создания ставки

При вводе суммы предложения автоматически рассчитывается и показывается:
- Сумма комиссии платформы
- Тип комиссии
- Сумма, которую получит мастер после вычета комиссии

## Преимущества системы

### Для клиентов:
- ✅ Не платят комиссию платформе
- ✅ Видят реальную стоимость работы
- ✅ Платят напрямую мастеру удобным способом

### Для мастеров:
- ✅ Льготные условия в первый месяц
- ✅ Прозрачная система комиссий
- ✅ Предварительный расчет перед созданием ставки
- ✅ Удобный интерфейс для отслеживания комиссий

### Для платформы:
- ✅ Стабильный источник дохода
- ✅ Мотивация мастеров качественно работать
- ✅ Простота администрирования
- ✅ Масштабируемость модели

## Пример расчета

### Пример 1: Первый месяц, первый заказ
- Сумма заказа: 150,000₸
- Комиссия: 5,000₸ (фиксированная)
- Мастер получит: 145,000₸

### Пример 2: Первый месяц, четвертый заказ
- Сумма заказа: 200,000₸
- Комиссия: 6,000₸ (3% от суммы)
- Мастер получит: 194,000₸

### Пример 3: Второй месяц
- Сумма заказа: 500,000₸
- Комиссия: 15,000₸ (3% от суммы)
- Мастер получит: 485,000₸

## Миграция данных

При обновлении системы автоматически выполняется миграция:
1. Добавляются новые поля в `master_profiles`
2. Создается таблица `commission_transactions`
3. Для существующих мастеров устанавливается дата регистрации = текущая дата

## Техническая документация

### Backend
- `server/src/services/commissionService.ts` - Сервис расчета и управления комиссиями
- `server/src/controllers/commissionController.ts` - Контроллер API
- `server/src/routes/commissionRoutes.ts` - Маршруты API

### Frontend
- `client/src/services/commissionService.ts` - Клиентский сервис
- `client/src/pages/master/MasterCommissions.tsx` - Страница комиссий
- Интеграция в форму создания ставки для предварительного расчета
